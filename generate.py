import sys
import os
from math import log
import numpy as np
import scipy as sp
from PIL import Image
from flask import Flask, flash, request, redirect, render_template
import matplotlib.pyplot as plt

# app=Flask(__name__)
# path = os.getcwd()
# GENERATE_FOLDER = os.path.join(path, 'uploads/images')
# UPLOAD_FOLDER = os.path.join(path, 'uploads/binary')

root= "/home/axe/AXE/PROJECTS/Malware classification/code/uploads/binary/"


# if not os.path.isdir(GENERATE_FOLDER):
#     os.mkdir(GENERATE_FOLDER)

# app.config['GENERATE_FOLDER'] = GENERATE_FOLDER

## This function allows us to process our hexadecimal files into png images##
# def convertAndSave(array,name):
    
#     print('Processing '+name)
#     if array.shape[1]!=16: #If not hexadecimal
#         assert(False)
#     b=int((array.shape[0]*16)**(0.5))
#     b=2**(int(log(b)/log(2))+1)
#     a=int(array.shape[0]*16/b)
#     array=array[:a*b//16,:]
#     array=np.reshape(array,(a,b))
#     im = Image.fromarray(np.uint8(array))
#     im.save(GENERATE_FOLDER+'/'+'tt.png', "PNG")
#     # im.save(os.path.join(app.config['GENERATE_FOLDER'], name +'.png', "PNG"))
#     return im

# #Get the list of files
# files=os.listdir(root)
# print('files : ',files)
# # #We will process files one by one.
# for counter, name in enumerate(files):
# #         #We only process .bytes files from our folder.
#         if '.bytes' != name[-6:]:
#             continue
#         f=open(root+'/'+name)
#         array=[]
#         for line in f:
#             xx=line.split()
#             if len(xx)!=17:
#                 continue
#             array.append([int(i,16) if i!='??' else 0 for i in xx[1:] ])
#         plt.imshow(convertAndSave(np.array(array),name))
#         del array
#         f.close()



## This function allows us to process our hexadecimal files into png images##
def convertAndSave(array,name):
    print('Processing '+name)
    if array.shape[1]!=16: #If not hexadecimal
        assert(False)
    b=int((array.shape[0]*16)**(0.5))
    b=2**(int(log(b)/log(2))+1)
    a=int(array.shape[0]*16/b)
    array=array[:a*b//16,:]
    array=np.reshape(array,(a,b))
    im = Image.fromarray(np.uint8(array))
    im.save(root+'\\'+'tt.png', "PNG")
    return im

#Get the list of files
files=os.listdir(root)
print('files : ',files)
#We will process files one by one.
for counter, name in enumerate(files):
        #We only process .bytes files from our folder.
        if '.bytes' != name[-6:]:
            continue
        f=open(root+'/'+name)
        array=[]
        for line in f:
            xx=line.split()
            if len(xx)!=17:
                continue
            array.append([int(i,16) if i!='??' else 0 for i in xx[1:] ])
        plt.imshow(convertAndSave(np.array(array),name))
        del array
        f.close()